// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// model User {
//   id        String   @id @default(uuid())
//   email     String   @unique
//   name      String?
//   createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
//   updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

//   // ridePlans RidePlan[]

//   @@map("user")
// }

model Plan {
  id       String   @id @default(uuid())
  title    String
  rideDate DateTime @map("ride_date")
  // userId String
  // user   User   @relation(fields: [userId], references: [id])

  startLat Float
  startLng Float

  endLat Float
  endLng Float

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // ridePlanTimelines    RidePlanTimeline[]
  // placeRecommendations PlaceRecommendation[]
  route          Route?
  places         Place[]
  recommendation Recommendation?

  waypoints Json? // [{lat, lng, order}]

  @@map("plan")
}

model Route {
  id     String @id @default(uuid())
  planId String @unique @map("plan_id")

  distance Float
  duration Int
  polyline String

  instructions     Json? // GraphHopper route instructions
  snappedWaypoints Json? // Road-snapped waypoint coordinates [[lat, lng], ...]

  segments Segment[]

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("route")
}

model Place {
  id     String @id @default(uuid())
  planId String @map("plan_id")

  name     String
  category String
  lat      Float
  lng      Float

  rating  Float?
  address String?
  source  PlaceSource

  plan Plan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())

  @@map("place")
}

enum PlaceSource {
  KAKAO
  NAVER
  GOOGLE
}

model Recommendation {
  id     String @id @default(uuid())
  planId String @unique @map("plan_id")

  summary              String   // "라이딩 후 가볍게 먹기 좋아요"
  placeIds             String[] // 추천 장소 id 목록
  estimatedTotalTimeMin Int?     @map("estimated_total_time_min") // 총 예상 시간(분)
  suggestedStops       Json?    @map("suggested_stops") // [{placeId, type, reason}]

  createdAt DateTime @default(now())
  plans     Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("recommendation")
}

// 라이딩 계획의 타임라인
// AI based data
// model RidePlanTimeline {
//   id     String @id @default(uuid())
//   planId String @map("plan_id")
//   plan   Plan   @relation(fields: [planId], references: [id])

//   order    Int
//   title    String
//   startMin Int    @map("start_min")
//   endMin   Int    @map("end_min")

//   @@map("ride_plan_timeline")
// }

// model Place {
//   id   String @id
//   name String
//   lat  Float
//   lng  Float

//   placeRecommendations PlaceRecommendation[]

//   @@map("place")
// }

// model PlaceRecommendation {
//   id      String @id @default(uuid())
//   planId  String @map("plan_id")
//   placeId String @map("place_id")

//   plan  Plan  @relation(fields: [planId], references: [id])
//   place Place @relation(fields: [placeId], references: [id])

//   reason String

//   @@map("place_recommendation")
// }

model Segment {
  id      String @id @default(uuid())
  routeId String @map("route_id")

  stravaId       Int    @map("strava_id")
  name           String
  climbCategory  Int    @map("climb_category") // 0=NC, 1-5
  avgGrade       Float  @map("avg_grade")
  startLat       Float  @map("start_lat")
  startLng       Float  @map("start_lng")
  endLat         Float  @map("end_lat")
  endLng         Float  @map("end_lng")
  elevDifference Float  @map("elev_difference")
  distance       Float
  polyline       String?

  effortCount  Int? @map("effort_count")
  athleteCount Int? @map("athlete_count")
  starCount    Int? @map("star_count")

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([routeId, stravaId])
  @@map("segment")
}

model StravaToken {
  id           String   @id @default(uuid())
  accessToken  String   @map("access_token")
  refreshToken String   @map("refresh_token")
  expiresAt    Int      @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("strava_token")
}
